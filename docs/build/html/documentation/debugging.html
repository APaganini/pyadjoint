
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Debugging</title>
    
    <link rel="stylesheet" href="../_static/fenics.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2017.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<link rel="stylesheet" href="../_static/featured.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="../_static/slides.min.jquery.js"></script>
  <script>
	$(function(){
		$('#products').slides({
			preload: true,
			preloadImage: 'img/loading.gif',
			effect: 'slide, fade',
			crossfade: true,
			slideSpeed: 350,
			fadeSpeed: 500,
			generateNextPrev: false,
			generatePagination: false,
	                play: 5000,
                        hoverPause: false,
                        animationStart: function(current){
				$('.caption').animate({
					bottom:-35
				},100);
				if (window.console && console.log) {
					// example return of current slide number
					console.log('animationStart on slide: ', current);
				};
			},
			animationComplete: function(current){
				$('.caption').animate({
					bottom:0
				},200);
				if (window.console && console.log) {
					// example return of current slide number
					console.log('animationComplete on slide: ', current);
				};
			},
			slidesLoaded: function() {
				$('.caption').animate({
					bottom:0
				},200);
			}
		});
	});
  </script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31806773-1']);
  _gaq.push(['_setDomainName', 'dolfin-adjoint.org']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<!-- Load the flex slider library -->
<link rel="stylesheet" href="_static/flexslider/flexslider.css" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script src="_static/flexslider/jquery.flexslider.js"></script>

<script type="text/javascript" charset="utf-8">
  $(window).load(function() {
  $('.flexslider').flexslider();
  });
</script>

<!-- Load the code highlight library -->
<link rel="stylesheet" href="_static/highlight/styles/zenburn.css">
<script src="_static/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<link rel="shortcut icon" href="../_static/icon.ico" />


  </head>
  <body>
<div class="wrapper">
  <a href="../"><img src="../_static/banner.png" width="900px" alt="dolfin-adjoint Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
          <li class="page_item"><a href="../about/index.html" title="Find out more about dolfin-adjoint">About</a></li>
          <li class="page_item"><a href="../features/index.html" title="Features of dolfin-adjoint">Features</a></li>
          <li class="page_item"><a href="index.html" title="Learn how to use dolfin-adjoint">Documentation</a></li>
          <li class="page_item"><a href="../download/index.html" title="Obtain the dolfin-adjoint code">Download</a></li>
          <li class="page_item"><a href="../citing/index.html" title="Learn how to cite the dolfin-adjoint project">Citing</a></li>
          <li class="page_item"><a href="../support/index.html" title="Where to go for more help">Support</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="debugging">
<h1>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h1>
<p>dolfin-adjoint offers a thorough suite of debugging routines, to identify exactly why the adjoint might not be
correct.</p>
<div class="section" id="visualising-the-forward-and-adjoint-systems">
<h2>Visualising the forward and adjoint systems<a class="headerlink" href="#visualising-the-forward-and-adjoint-systems" title="Permalink to this headline">¶</a></h2>
<p>It is sometimes useful when debugging a problem to see dolfin-adjoint’s interpretation of your forward system,
and the other models it derives from that. The <code class="xref py py-func docutils literal"><span class="pre">adj_html</span></code> function dumps a HTML visualisation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">adj_html</span><span class="p">(</span><span class="s2">&quot;forward.html&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">)</span>
<span class="n">adj_html</span><span class="p">(</span><span class="s2">&quot;adjoint.html&quot;</span><span class="p">,</span> <span class="s2">&quot;adjoint&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For example, let us include these in the Burgers’ equation example:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dolfin</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dolfin_adjoint</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">adj_checkpointing</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;multistage&#39;</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                  <span class="n">snaps_on_disk</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">snaps_in_ram</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">VectorFunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ic</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">Expression</span><span class="p">((</span><span class="s2">&quot;sin(2*pi*x[0])&quot;</span><span class="p">,</span> <span class="s2">&quot;cos(2*pi*x[1])&quot;</span><span class="p">),</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>  <span class="n">V</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">u_next</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="n">timestep</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">inner</span><span class="p">((</span><span class="n">u_next</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">/</span><span class="n">timestep</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_next</span><span class="p">)</span><span class="o">*</span><span class="n">u_next</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">nu</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_next</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span><span class="o">*</span><span class="n">dx</span>

    <span class="n">bc</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s2">&quot;on_boundary&quot;</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">end</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">solve</span><span class="p">(</span><span class="n">F</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u_next</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">u_next</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">timestep</span><span class="p">)</span>
        <span class="n">adj_inc_timestep</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">u</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>

    <span class="n">adj_html</span><span class="p">(</span><span class="s2">&quot;forward.html&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">)</span>
<span class="hll">    <span class="n">adj_html</span><span class="p">(</span><span class="s2">&quot;adjoint.html&quot;</span><span class="p">,</span> <span class="s2">&quot;adjoint&quot;</span><span class="p">)</span>
</span><span class="hll">
</span>    <span class="n">J</span> <span class="o">=</span> <span class="n">Functional</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="o">*</span><span class="n">dt</span><span class="p">[</span><span class="n">FINISH_TIME</span><span class="p">])</span>
    <span class="n">dJdnu</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Control</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>

    <span class="n">Jnu</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>

    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;adjoint&quot;</span><span class="p">][</span><span class="s2">&quot;stop_annotating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">def</span> <span class="nf">Jhat</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assemble</span><span class="p">(</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>

    <span class="n">conv_rate</span> <span class="o">=</span> <span class="n">taylor_test</span><span class="p">(</span><span class="n">Jhat</span><span class="p">,</span> <span class="n">Control</span><span class="p">(</span><span class="n">nu</span><span class="p">),</span> <span class="n">Jnu</span><span class="p">,</span> <span class="n">dJdnu</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="more info" class="align-middle" src="../_images/more.png" /> Download the <a class="reference external" href="../_static/tutorial7.py">code to dump the HTML visualisation</a>.</p>
<p>The resulting <a class="reference external" href="../_static/forward.html">forward</a> and <a class="reference external" href="../_static/adjoint.html">adjoint</a> tables are available for inspection.</p>
<p>Each row corresponds to one equation solve. The variable being solved for is listed
at the top. If the variable is green, the value of that variable is recorded; if the
variable is red, the value of that variable is not recorded. To identify the dependencies
of each operator, hover over the block (on the diagonal and on the rhs) with the mouse.</p>
</div>
<div class="section" id="replaying-the-forward-run">
<h2>Replaying the forward run<a class="headerlink" href="#replaying-the-forward-run" title="Permalink to this headline">¶</a></h2>
<p>In order to derive a consistent adjoint model, dolfin-adjoint must correctly understand
your forward model. If dolfin-adjoint’s record of your forward model is incorrect, then it
cannot derive a correct adjoint model.</p>
<p>One way this could happen is if the forward model manually modifies the <code class="xref py py-data docutils literal"><span class="pre">vector()</span></code>
of a <code class="xref py py-class docutils literal"><span class="pre">Function</span></code>. For example, suppose that instead of using</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">u_next</span><span class="p">)</span>
</pre></div>
</div>
<p>the code used</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">u_next</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
</pre></div>
</div>
<p>then the adjoint would be incorrect, as dolfin-adjoint cannot detect the modification:</p>
<div class="highlight-none"><div class="highlight"><pre>$ python tutorial_incorrect.py
...
Convergence orders for Taylor remainder with adjoint information (should all be 2):
  [0.9544004555220237, 0.9767390399643741, 0.9882512926547484, 0.9940957131097388]
</pre></div>
</div>
<p>How would we detect this situation? To check the <em>consistency</em> of dolfin-adjoint’s annotation,
it can <strong>replay its interpretation of the forward model and compare the results to the real
forward model</strong>. To do this, use the <code class="xref py py-func docutils literal"><span class="pre">replay_dolfin</span></code> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">success</span> <span class="o">=</span> <span class="n">replay_dolfin</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>To see this in action, consider the following (<strong>incorrect</strong>) code:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dolfin</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dolfin_adjoint</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">VectorFunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ic</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">Expression</span><span class="p">((</span><span class="s2">&quot;sin(2*pi*x[0])&quot;</span><span class="p">,</span> <span class="s2">&quot;cos(2*pi*x[1])&quot;</span><span class="p">),</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>  <span class="n">V</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">u_next</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="n">timestep</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">inner</span><span class="p">((</span><span class="n">u_next</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span><span class="o">/</span><span class="n">timestep</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_next</span><span class="p">)</span><span class="o">*</span><span class="n">u_next</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">nu</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_next</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span><span class="o">*</span><span class="n">dx</span>

    <span class="n">bc</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s2">&quot;on_boundary&quot;</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">end</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">):</span>
<span class="hll">        <span class="n">solve</span><span class="p">(</span><span class="n">F</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u_next</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span>
</span>        <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">u_next</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">timestep</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">u</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
<span class="hll">
</span>    <span class="n">success</span> <span class="o">=</span> <span class="n">replay_dolfin</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="more info" class="align-middle" src="../_images/more.png" /> Download the <a class="reference external" href="../_static/tutorial8.py">broken adjoint code, where the error is detected by replay</a>.</p>
<p>The replay detects that the interpretation and the real forward model diverge:</p>
<div class="highlight-none"><div class="highlight"><pre>$ python tutorial8.py
...
Comparing w_4:1:0:Forward against previously recorded value:
   norm of the difference is 7.120735e-02 (&gt; tolerance of 0.000000e+00)
</pre></div>
</div>
<p><code class="xref py py-data docutils literal"><span class="pre">w_4</span></code> refers to <code class="xref py py-data docutils literal"><span class="pre">u_next</span></code> (try printing it), and <code class="xref py py-data docutils literal"><span class="pre">w_4:1:0</span></code> means
“the function w_4 at timestep 1 and iteration 0”. In this error message, libadjoint
tells us that the second solution of <code class="xref py py-data docutils literal"><span class="pre">u_next</span></code> is different in the replay than in the forward model.
Of course, this is because dolfin-adjoint’s knowledge of the value of <code class="xref py py-data docutils literal"><span class="pre">u</span></code> is wrong. With this
information, the user can inspect the code around the solution for <code class="xref py py-data docutils literal"><span class="pre">u_next</span></code> and examine
more closely.</p>
<p>Note that the replay cannot be exactly perfect when the model is run in parallel:
the order of the parallel reductions is nondeterministic, and so the answers can diverge
within floating-point roundoff. When debugging, run in serial.</p>
</div>
<div class="section" id="testing-the-derivatives-of-operators">
<h2>Testing the derivatives of operators<a class="headerlink" href="#testing-the-derivatives-of-operators" title="Permalink to this headline">¶</a></h2>
<p>If the replay works perfectly, but the adjoint is still incorrect, then there are very
few possibilities for what could be wrong. The only other major possibility is if the
model uses a <em>discretisation that is not differentiable</em>. In order to assemble the
adjoint equations, any operators in the forward model that depend on previously computed values
must be differentiated with respect to those values. If that dependency is not differentiable,
then no consistent derivative of the model exists.</p>
<p>A simple way to check the differentiability of your model is to set</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;adjoint&quot;</span><span class="p">][</span><span class="s2">&quot;test_derivative&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>before solving any equations. Then, whenever libadjoint goes to assemble a term
involving the derivative of a nonlinear operator, it will apply the <a class="reference internal" href="verification.html"><span class="doc">Taylor test</span></a>
(at the level of the operator, instead of the whole model). For example, a typical error message
from the derivative test looks like</p>
<div class="highlight-python"><div class="highlight"><pre><span class="go">&gt;&gt;&gt;&gt;</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">libadjoint.exceptions.LibadjointWarnComparisonFailed</span>: <span class="n">Expected the Taylor series remainder</span>
<span class="go">   of operator 96c04e026b91e44576aa43ccef66e6a8 with respect to w_{16}:1:22:Forward to</span>
<span class="go">   converge at second order, but got 1.000000</span>
<span class="go">   (the error values are 1.393963e-11 and 6.969817e-12).</span>
</pre></div>
</div>
<p>In this message, libadjoint tells us that the operator “96c04e026b91e44576aa43ccef66e6a8” (the names are automatically generated from the hash of the form) depends on the variable
w_{16}:1:22, but that its dependence is not differentiable (the Taylor remainder convergence test yielded 1, instead of 2). In this example, the operator is an upwinded DG
discretisation of the advection operator, and w_{16}:1:22 is an advecting velocity.</p>
<p>Note that even if the adjoint is not perfectly consistent (i.e., the Taylor remainders do not converge at second order), the resulting
gradients can still be “good enough” for the purposes of an optimisation algorithm. All that matters to the optimisation algorithm is
that the gradient provides a descent direction; if the Taylor remainders are “small”, then the convergence of the algorithm will usually
not be affected. Thus, <strong>the adjoint is generally still useful, even for nondifferentiable discretisations</strong>.</p>
<p>Note that a more rigorous approach for the case where the functional is nondifferentiable is to consider the functional gradient produced by the adjoint as a
<em>subgradient</em>. For more information, see <a class="reference external" href="http://en.wikipedia.org/wiki/Subgradient_method">the Wikipedia</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, The dolfin-adjoint team.
    </div>
  </body>
</html>