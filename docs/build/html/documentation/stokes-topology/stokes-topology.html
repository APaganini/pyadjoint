
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Topology optimisation of fluids in Stokes flow</title>
    
    <link rel="stylesheet" href="../../_static/fenics.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2017.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<link rel="stylesheet" href="../../_static/featured.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="../../_static/slides.min.jquery.js"></script>
  <script>
	$(function(){
		$('#products').slides({
			preload: true,
			preloadImage: 'img/loading.gif',
			effect: 'slide, fade',
			crossfade: true,
			slideSpeed: 350,
			fadeSpeed: 500,
			generateNextPrev: false,
			generatePagination: false,
	                play: 5000,
                        hoverPause: false,
                        animationStart: function(current){
				$('.caption').animate({
					bottom:-35
				},100);
				if (window.console && console.log) {
					// example return of current slide number
					console.log('animationStart on slide: ', current);
				};
			},
			animationComplete: function(current){
				$('.caption').animate({
					bottom:0
				},200);
				if (window.console && console.log) {
					// example return of current slide number
					console.log('animationComplete on slide: ', current);
				};
			},
			slidesLoaded: function() {
				$('.caption').animate({
					bottom:0
				},200);
			}
		});
	});
  </script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31806773-1']);
  _gaq.push(['_setDomainName', 'dolfin-adjoint.org']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<!-- Load the flex slider library -->
<link rel="stylesheet" href="_static/flexslider/flexslider.css" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script src="_static/flexslider/jquery.flexslider.js"></script>

<script type="text/javascript" charset="utf-8">
  $(window).load(function() {
  $('.flexslider').flexslider();
  });
</script>

<!-- Load the code highlight library -->
<link rel="stylesheet" href="_static/highlight/styles/zenburn.css">
<script src="_static/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<link rel="shortcut icon" href="../../_static/icon.ico" />


  </head>
  <body>
<div class="wrapper">
  <a href="../../"><img src="../../_static/banner.png" width="900px" alt="dolfin-adjoint Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
          <li class="page_item"><a href="../../about/index.html" title="Find out more about dolfin-adjoint">About</a></li>
          <li class="page_item"><a href="../../features/index.html" title="Features of dolfin-adjoint">Features</a></li>
          <li class="page_item"><a href="../index.html" title="Learn how to use dolfin-adjoint">Documentation</a></li>
          <li class="page_item"><a href="../../download/index.html" title="Obtain the dolfin-adjoint code">Download</a></li>
          <li class="page_item"><a href="../../citing/index.html" title="Learn how to cite the dolfin-adjoint project">Citing</a></li>
          <li class="page_item"><a href="../../support/index.html" title="Where to go for more help">Support</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="topology-optimisation-of-fluids-in-stokes-flow">
<h1>Topology optimisation of fluids in Stokes flow<a class="headerlink" href="#topology-optimisation-of-fluids-in-stokes-flow" title="Permalink to this headline">¶</a></h1>
<p>This demo solves example 4 of <a class="reference internal" href="#borrvall2003" id="id1">[4E-BP03]</a>.</p>
<div class="section" id="problem-definition">
<h2>Problem definition<a class="headerlink" href="#problem-definition" title="Permalink to this headline">¶</a></h2>
<p>This problem is to minimise the dissipated power in the fluid</p>
<div class="math">
\[\frac{1}{2} \int_{\Omega} \alpha(\rho) u \cdot u + \frac{\mu}{2} \int_{\Omega} \nabla u : \nabla u - \int_{\Omega} f u\]</div>
<p>subject to the Stokes equations with velocity Dirichlet conditions</p>
<div class="math">
\[\begin{split}\alpha(\rho) u - \mu \nabla^2 u + \nabla p &amp;= f \qquad \mathrm{in} \ \Omega        \\
                           \mathrm{div}(u) &amp;= 0 \qquad \mathrm{on} \ \Omega        \\
                                         u &amp;= b \qquad \mathrm{on} \ \delta \Omega \\\end{split}\]</div>
<p>and to the control constraints on available fluid volume</p>
<div class="math">
\[\begin{split}0 \le \rho(x) &amp;\le 1  \qquad \forall x \in \Omega \\
\int_{\Omega} \rho &amp;\le V\end{split}\]</div>
<p>where <span class="math">\(u\)</span> is the velocity, <span class="math">\(p\)</span> is the pressure,
<span class="math">\(\rho\)</span> is the control (<span class="math">\(\rho(x) = 1\)</span> means fluid present,
<span class="math">\(\rho(x) = 0\)</span> means no fluid present), <span class="math">\(f\)</span> is a prescribed
source term (here 0), <span class="math">\(V\)</span> is the volume bound on the control,
<span class="math">\(\alpha(\rho)\)</span> models the inverse permeability as a function of
the control</p>
<div class="math">
\[\alpha(\rho) = \bar{\alpha} + (\underline{\alpha} - \bar{\alpha}) \rho \frac{1 + q}{\rho + q}\]</div>
<p>with <span class="math">\(\bar{\alpha}\)</span>, <span class="math">\(\underline{\alpha}\)</span> and <span class="math">\(q\)</span>
prescribed constants. The parameter <span class="math">\(q\)</span> penalises deviations
from the values 0 or 1; the higher q, the closer the solution will be
to having the two discrete values 0 or 1.</p>
<p>The problem domain <span class="math">\(\Omega\)</span> is parameterised by the aspect ratio
<span class="math">\(\delta\)</span> (the domain is 1 unit high and <span class="math">\(\delta\)</span> units
wide); in this example, we will solve the harder problem of
<span class="math">\(\delta = 1.5\)</span>.  The boundary conditions are specified in figure
10 of Borrvall and Petersson, reproduced here.</p>
<a class="reference internal image-reference" href="../../_images/stokes-topology-bcs.png"><img alt="../../_images/stokes-topology-bcs.png" class="align-center" src="../../_images/stokes-topology-bcs.png" style="width: 614.4px; height: 489.6px;" /></a>
<p>Physically, this problem corresponds to finding the fluid-solid
distribution <span class="math">\(\rho(x)\)</span> that minimises the dissipated power in
the fluid.</p>
<p>As Borrvall and Petersson comment, it is necessary to solve this
problem with <span class="math">\(q=0.1\)</span> to ensure that the result approaches a
discrete-valued solution, but solving this problem directly with this
value of <span class="math">\(q\)</span> leads to a local minimum configuration of two
straight pipes across the domain (like the top half of figure 11).
Therefore, we follow their suggestion to first solve the optimisation
problem with a smaller penalty parameter of <span class="math">\(q=0.01\)</span>; this
optimisation problem does not yield bang-bang solutions but is easier
to solve, and gives an initial guess from which the <span class="math">\(q=0.1\)</span> case
converges to the better minimum.</p>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>First, the <code class="xref py py-mod docutils literal"><span class="pre">dolfin</span></code> and <code class="xref py py-mod docutils literal"><span class="pre">dolfin_adjoint</span></code> modules are
imported:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">dolfin</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dolfin_adjoint</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Next we import the Python interface to IPOPT. If IPOPT is
unavailable on your system, we strongly <a class="reference internal" href="../../download/index.html"><span class="doc">suggest you install it</span></a>; IPOPT is a well-established open-source
optimisation algorithm.</p>
<div class="highlight-default"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyipopt</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">info_red</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;This example depends on IPOPT and pyipopt. </span><span class="se">\</span>
<span class="s2">  When compiling IPOPT, make sure to link against HSL, as it </span><span class="se">\</span>
<span class="s2">  is a necessity for practical problems.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">raise</span>

<span class="c1"># turn off redundant output in parallel</span>
<span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;std_out_all_processes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Next we define some constants, and define the inverse permeability as
a function of <span class="math">\(\rho\)</span>.</p>
<div class="highlight-default"><div class="highlight"><pre><span class="n">mu</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>                   <span class="c1"># viscosity</span>
<span class="n">alphaunderbar</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># parameter for \alpha</span>
<span class="n">alphabar</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.01</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>      <span class="c1"># parameter for \alpha</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span> <span class="c1"># q value that controls difficulty/discrete-valuedness of solution</span>

<span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="n">rho</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inverse permeability as a function of rho, equation (40)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">alphabar</span> <span class="o">+</span> <span class="p">(</span><span class="n">alphaunderbar</span> <span class="o">-</span> <span class="n">alphabar</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<p>Next we define the mesh (a rectangle 1 high and <span class="math">\(\delta\)</span> wide)
and the function spaces to be used for the control <span class="math">\(\rho\)</span>, the
velocity <span class="math">\(u\)</span> and the pressure <span class="math">\(p\)</span>. Here we will use the
Taylor-Hood finite element to discretise the Stokes equations
<a class="reference internal" href="#taylor1973" id="id2">[4E-TH73]</a>.</p>
<div class="highlight-default"><div class="highlight"><pre><span class="n">N</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">delta</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># The aspect ratio of the domain, 1 high and \delta wide</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta</span>  <span class="c1"># want the fluid to occupy 1/3 of the domain</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">RectangleMesh</span><span class="p">(</span><span class="n">mpi_comm_world</span><span class="p">(),</span> <span class="n">Point</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c1"># control function space</span>

<span class="n">U_h</span> <span class="o">=</span> <span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">P_h</span> <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">U_h</span><span class="o">*</span><span class="n">P_h</span><span class="p">)</span>          <span class="c1"># mixed Taylor-Hood function space</span>
</pre></div>
</div>
<p>Define the boundary condition on velocity</p>
<div class="highlight-default"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InflowOutflow</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span>
        <span class="n">gbar</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">delta</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">/</span><span class="mi">4</span>
                <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gbar</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">3.0</span><span class="o">/</span><span class="mi">4</span>
                <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gbar</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">value_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
</pre></div>
</div>
<p>Next we define a function that given a control <span class="math">\(\rho\)</span> solves the
forward PDE for velocity and pressure <span class="math">\((u, p)\)</span>. (The advantage
of formulating it in this manner is that it makes it easy to conduct
<a class="reference internal" href="../verification.html"><span class="doc">Taylor remainder convergence tests</span></a>.)</p>
<div class="highlight-default"><div class="highlight"><pre><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">rho</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solve the forward problem for a given fluid distribution rho(x).&quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
    <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">TestFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

    <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span>
         <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>  <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">InflowOutflow</span><span class="p">(),</span> <span class="s2">&quot;on_boundary&quot;</span><span class="p">)</span>
    <span class="n">solve</span><span class="p">(</span><span class="n">F</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w</span>
</pre></div>
</div>
<p>Now we define the <code class="docutils literal"><span class="pre">__main__</span></code> section. We define the initial guess
for the control and use it to solve the forward PDE. In order to
ensure feasibility of the initial control guess, we interpolate the
volume bound; this ensures that the integral constraint and the bound
constraint are satisfied.</p>
<div class="highlight-default"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="n">delta</span><span class="p">),</span> <span class="n">A</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Control&quot;</span><span class="p">)</span>
    <span class="n">w</span>   <span class="o">=</span> <span class="n">forward</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
    <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</pre></div>
</div>
<p>With the forward problem solved once, <code class="xref py py-mod docutils literal"><span class="pre">dolfin_adjoint</span></code> has
built a <em>tape</em> of the forward model; it will use this tape to drive
the optimisation, by repeatedly solving the forward model and the
adjoint model for varying control inputs.</p>
<p>As in the <a class="reference internal" href="../poisson-topology/poisson-topology.html"><span class="doc">Poisson topology example</span></a>, we will use an evaluation
callback to dump the control iterates to disk for visualisation. As
this optimisation problem (<span class="math">\(q=0.01\)</span>) is solved only to generate
an initial guess for the main task (<span class="math">\(q=0.1\)</span>), we shall save
these iterates in <code class="docutils literal"><span class="pre">output/control_iterations_guess.pvd</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span class="n">controls</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s2">&quot;output/control_iterations_guess.pvd&quot;</span><span class="p">)</span>
<span class="n">allctrls</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s2">&quot;output/allcontrols.pvd&quot;</span><span class="p">)</span>
<span class="n">rho_viz</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ControlVisualisation&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_cb</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="n">rho_viz</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
    <span class="n">controls</span> <span class="o">&lt;&lt;</span> <span class="n">rho_viz</span>
    <span class="n">allctrls</span> <span class="o">&lt;&lt;</span> <span class="n">rho_viz</span>
</pre></div>
</div>
<p>Now we define the functional and <a class="reference internal" href="../maths/2-problem.html"><span class="doc">reduced functional</span></a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="n">J</span> <span class="o">=</span> <span class="n">Functional</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">alpha</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">Control</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
<span class="n">Jhat</span> <span class="o">=</span> <span class="n">ReducedFunctional</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">eval_cb_post</span><span class="o">=</span><span class="n">eval_cb</span><span class="p">)</span>
</pre></div>
</div>
<p>The control constraints are the same as the <a class="reference internal" href="../poisson-topology/poisson-topology.html"><span class="doc">Poisson topology
example</span></a>, and so won’t be
discussed again here.</p>
<div class="highlight-default"><div class="highlight"><pre><span class="c1"># Bound constraints</span>
<span class="n">lb</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">ub</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Volume constraints</span>
<span class="k">class</span> <span class="nc">VolumeConstraint</span><span class="p">(</span><span class="n">InequalityConstraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that enforces the volume constraint g(a) = V - a*dx &gt;= 0.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</pre></div>
</div>
<p>The derivative of the constraint g(x) is constant
(it is the negative of the diagonal of the lumped mass matrix for the
control function space), so let’s assemble it here once.
This is also useful in rapidly calculating the integral each time
without re-assembling.</p>
<div class="highlight-default"><div class="highlight"><pre>    <span class="bp">self</span><span class="o">.</span><span class="n">smass</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tmpvec</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluting constraint residual&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tmpvec</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">m</span>

    <span class="c1"># Compute the integral of the control over the domain</span>
    <span class="n">integral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smass</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpvec</span><span class="o">.</span><span class="n">vector</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current control integral: &quot;</span><span class="p">,</span> <span class="n">integral</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">-</span> <span class="n">integral</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing constraint Jacobian&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">smass</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">output_workspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
</pre></div>
</div>
<p>Now that all the ingredients are in place, we can perform the initial
optimisation. We set the maximum number of iterations for this initial
optimisation problem to 30; there’s no need to solve this to
completion, as its only purpose is to generate an initial guess.</p>
<div class="highlight-default"><div class="highlight"><pre><span class="c1"># Solve the optimisation problem with q = 0.01</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">MinimizationProblem</span><span class="p">(</span><span class="n">Jhat</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">VolumeConstraint</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;maximum_iterations&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>

<span class="n">solver</span> <span class="o">=</span> <span class="n">IPOPTSolver</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
<span class="n">rho_opt</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="n">rho_opt_xdmf</span> <span class="o">=</span> <span class="n">XDMFFile</span><span class="p">(</span><span class="n">mpi_comm_world</span><span class="p">(),</span> <span class="s2">&quot;output/control_solution_guess.xdmf&quot;</span><span class="p">)</span>
<span class="n">rho_opt_xdmf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rho_opt</span><span class="p">)</span>
</pre></div>
</div>
<p>With the optimised value for <span class="math">\(q=0.01\)</span> in hand, we <em>reset</em> the
dolfin-adjoint state, clearing its tape, and configure the new problem
we want to solve. We need to update the values of <span class="math">\(q\)</span> and
<span class="math">\(\rho\)</span>:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="n">q</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">rho</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">rho_opt</span><span class="p">)</span>
<span class="n">adj_reset</span><span class="p">()</span>
</pre></div>
</div>
<p>Since we have cleared the tape, we need to execute the forward model
once again to redefine the problem. (It is also possible to modify the
tape, but this way is easier to understand.) We will also redefine the
functionals and parameters; this time, the evaluation callback will
save the optimisation iterations to
<code class="docutils literal"><span class="pre">output/control_iterations_final.pvd</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span class="n">rho_intrm</span> <span class="o">=</span> <span class="n">XDMFFile</span><span class="p">(</span><span class="n">mpi_comm_world</span><span class="p">(),</span> <span class="s2">&quot;intermediate-guess-</span><span class="si">%s</span><span class="s2">.xdmf&quot;</span> <span class="o">%</span> <span class="n">N</span><span class="p">)</span>
<span class="n">rho_intrm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">forward</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
<span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

<span class="c1"># Define the reduced functionals</span>
<span class="n">controls</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s2">&quot;output/control_iterations_final.pvd&quot;</span><span class="p">)</span>
<span class="n">rho_viz</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ControlVisualisation&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_cb</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="n">rho_viz</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
    <span class="n">controls</span> <span class="o">&lt;&lt;</span> <span class="n">rho_viz</span>
    <span class="n">allctrls</span> <span class="o">&lt;&lt;</span> <span class="n">rho_viz</span>

<span class="n">J</span> <span class="o">=</span> <span class="n">Functional</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">alpha</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">Control</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
<span class="n">Jhat</span> <span class="o">=</span> <span class="n">ReducedFunctional</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">eval_cb_post</span><span class="o">=</span><span class="n">eval_cb</span><span class="p">)</span>
</pre></div>
</div>
<p>We can now solve the optimisation problem with <span class="math">\(q=0.1\)</span>, starting
from the solution of <span class="math">\(q=0.01\)</span>:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="n">problem</span> <span class="o">=</span> <span class="n">MinimizationProblem</span><span class="p">(</span><span class="n">Jhat</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">VolumeConstraint</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;maximum_iterations&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

<span class="n">solver</span> <span class="o">=</span> <span class="n">IPOPTSolver</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
<span class="n">rho_opt</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="n">rho_opt_final</span> <span class="o">=</span> <span class="n">XDMFFile</span><span class="p">(</span><span class="n">mpi_comm_world</span><span class="p">(),</span> <span class="s2">&quot;output/control_solution_final.xdmf&quot;</span><span class="p">)</span>
<span class="n">rho_opt_final</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rho_opt</span><span class="p">)</span>
</pre></div>
</div>
<p>The example code can be found in <code class="docutils literal"><span class="pre">examples/stokes-topology/</span></code> in the
<code class="docutils literal"><span class="pre">dolfin-adjoint</span></code> source tree, and executed as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre>$ mpiexec -n <span class="m">4</span> python stokes-topology.py
...
Number of Iterations....: 100

                                   <span class="o">(</span>scaled<span class="o">)</span>                 <span class="o">(</span>unscaled<span class="o">)</span>
Objective...............:   4.5944633030224409e+01    4.5944633030224409e+01
Dual infeasibility......:   1.8048641504211900e-03    1.8048641504211900e-03
Constraint violation....:   0.0000000000000000e+00    0.0000000000000000e+00
Complementarity.........:   9.6698653740681504e-05    9.6698653740681504e-05
Overall NLP error.......:   1.8048641504211900e-03    1.8048641504211900e-03


Number of objective <span class="k">function</span> <span class="nv">evaluations</span>             <span class="o">=</span> 105
Number of objective gradient <span class="nv">evaluations</span>             <span class="o">=</span> 101
Number of equality constraint <span class="nv">evaluations</span>            <span class="o">=</span> 0
Number of inequality constraint <span class="nv">evaluations</span>          <span class="o">=</span> 105
Number of equality constraint Jacobian <span class="nv">evaluations</span>   <span class="o">=</span> 0
Number of inequality constraint Jacobian <span class="nv">evaluations</span> <span class="o">=</span> 101
Number of Lagrangian Hessian <span class="nv">evaluations</span>             <span class="o">=</span> 0
Total CPU secs in IPOPT <span class="o">(</span>w/o <span class="k">function</span> evaluations<span class="o">)</span>   <span class="o">=</span>     11.585
Total CPU secs in NLP <span class="k">function</span> <span class="nv">evaluations</span>           <span class="o">=</span>    556.795

EXIT: Maximum Number of Iterations Exceeded.
</pre></div>
</div>
<p>The optimisation iterations can be visualised by opening
<code class="docutils literal"><span class="pre">output/control_iterations_final.pvd</span></code> in paraview. The resulting
solution appears very similar to the solution proposed in
<a class="reference internal" href="#borrvall2003" id="id3">[4E-BP03]</a>.</p>
<a class="reference internal image-reference" href="../../_images/stokes-topology.png"><img alt="../../_images/stokes-topology.png" class="align-center" src="../../_images/stokes-topology.png" style="width: 799.0px; height: 266.5px;" /></a>
<p class="rubric">References</p>
<p id="bibtex-bibliography-documentation/stokes-topology/stokes-topology-0"><table class="docutils citation" frame="void" id="borrvall2003" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4E-BP03]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id3">2</a>)</em> T.&nbsp;Borrvall and J.&nbsp;Petersson. Topology optimization of fluids in Stokes flow. <em>International Journal for Numerical Methods in Fluids</em>, 41(1):77–107, 2003. <a class="reference external" href="https://doi.org/10.1002/fld.426">doi:10.1002/fld.426</a>.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="taylor1973" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[4E-TH73]</a></td><td>C.&nbsp;Taylor and P.&nbsp;Hood. A numerical solution of the Navier-Stokes equations using the finite element technique. <em>Computers &amp; Fluids</em>, 1(1):73–100, 1973. <a class="reference external" href="https://doi.org/10.1016/0045-7930(73)90027-3">doi:10.1016/0045-7930(73)90027-3</a>.</td></tr>
</tbody>
</table>
</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Sebastian Mitusch.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.2.
    </div>
  </body>
</html>